// functions/exportTicketsToXLSX.js

const functions = require('firebase-functions');
const admin   = require('firebase-admin');
const ExcelJS = require('exceljs');

admin.initializeApp();
const db = admin.firestore();

// Authorized UID for export
const ALLOWED_UID = 'nVd3eJrI6KVrIVVciPxLs1vZxfj1';

exports.exportTicketsToXLSX = functions.https.onCall(async (data, context) => {
  // 1. Auth check
  if (!context.auth) {
    throw new functions.https.HttpsError(
      'unauthenticated',
      'You must be signed in to export tickets.'
    );
  }
  const uid = context.auth.uid;
  const claims = context.auth.token.role;
  const isAdmin = claims === 'admin';

  if (uid !== ALLOWED_UID && !isAdmin) {
    throw new functions.https.HttpsError(
      'permission-denied',
      'You do not have permission to export tickets.'
    );
  }

  try {
    // 2. Fetch tickets
    const snapshot = await db.collection('tickets').get();
    if (snapshot.empty) {
      console.log('No tickets found for export.');
      return { message: 'No tickets to export.' };
    }

    // 3. Prepare workbook
    const workbook = new ExcelJS.Workbook();
    const sheet = workbook.addWorksheet('Tickets');

    // 4. Define columns
    sheet.columns = [
      { header: 'Ticket Number',       key: 'ticketNumber',      width: 20 },
      { header: 'Weight (tons)',       key: 'weight',            width: 15 },
      { header: 'Truck Number',        key: 'truckNumber',       width: 15 },
      { header: 'Capacity',            key: 'capacity',          width: 15 },
      { header: 'Driver',              key: 'driver',            width: 25 },
      { header: 'User',                key: 'user',              width: 25 },
      { header: 'Debris Type',         key: 'debrisType',        width: 20 },
      { header: 'Load Call',           key: 'loadCall',          width: 20 },
      { header: 'Disposal DateTime',   key: 'disposalDateTime',  width: 25 },
      // add more columns here as needed...
    ];

    // 5. Populate rows
    snapshot.forEach(doc => {
      const d = doc.data() || {};
      sheet.addRow({
        ticketNumber:       d.ticketNumber       || '',
        weight:             d.weight != null     ? d.weight : '',
        truckNumber:        d.truckNumber        || '',
        capacity:           d.capacity != null   ? d.capacity : '',
        driver:             d.driver             || '',
        user:               d.user               || '',
        debrisType:         d.debris

